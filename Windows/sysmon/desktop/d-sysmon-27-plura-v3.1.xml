<!-- PLURA_CONFIG_VERSION: d-sysmon-27-plura-v3.1.xml --> 
<!-- PLURA_SCHEMA_TARGET: 4.90 -->

<Sysmon schemaversion="4.90">
  <EventFiltering>

    <!-- SYSMON EVENT ID 27 : FILE BLOCK EXECUTABLE [FileBlockExecutable] - Desktop (강화 버전) -->

    <!-- INCLUDE: 악성 Drop/Run 경로 + PowerShell/LOLBin까지 강하게 차단 -->
    <RuleGroup name="Include_MalwareDrop_Desktop" groupRelation="or">
      <FileBlockExecutable onmatch="include">

        <!-- (A) 사용자 데이터 보호 (Honeypot) -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains any">
            \Documents\;
            \Pictures\;
            \Videos\;
            \Music\;
            \Favorites\;
            \Client_Contracts\
          </TargetFilename>
        </Rule>

        <!-- (B) 공격자 임시 Drop & Run 경로
               - 사용자 임시 폴더, Temp, Downloads 등 -->
        <Rule groupRelation="or">
          <!-- 사용자 임시 폴더 -->
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
          <!-- Windows Temp -->
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
          <!-- Downloads 디렉터리 -->
          <TargetFilename condition="contains">\Downloads\</TargetFilename>
        </Rule>

        <!-- (C) 공격자들이 자주 사용하는 Drop 경로 (예: C:\ProgramData, Public 등) -->
        <Rule groupRelation="or">
          <TargetFilename condition="begin with">C:\ProgramData\</TargetFilename>
          <TargetFilename condition="begin with">C:\Users\Public\</TargetFilename>
        </Rule>

        <!-- (D) PowerShell 스크립트 실행 차단 -->
        <Rule groupRelation="or">
          <TargetFilename condition="end with">.ps1</TargetFilename>
          <TargetFilename condition="end with">.psm1</TargetFilename>
          <TargetFilename condition="end with">.psd1</TargetFilename>
        </Rule>

        <!-- (E) LOLBin/LOLScript Drop & Run 패턴 차단 -->
        <Rule groupRelation="or">
          <!-- 공용 LOLBin 위치 -->
          <TargetFilename condition="end with">\certutil.exe</TargetFilename>
          <TargetFilename condition="end with">\bitsadmin.exe</TargetFilename>
          <TargetFilename condition="end with">\mshta.exe</TargetFilename>
          <TargetFilename condition="end with">\wscript.exe</TargetFilename>
          <TargetFilename condition="end with">\cscript.exe</TargetFilename>
          <TargetFilename condition="end with">\powershell.exe</TargetFilename>
          <TargetFilename condition="end with">\pwsh.exe</TargetFilename>
          <TargetFilename condition="end with">\regsvr32.exe</TargetFilename>
        </Rule>

        <!-- (F) Office 매크로가 드랍하는 실행 파일 (일반적인 Temp 위치) -->
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
          <TargetFilename condition="end with">.exe</TargetFilename>
        </Rule>

        <!-- (G) 악성 Word/Excel 매크로에서 Dropping하는 경로 (예시) -->
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\</TargetFilename>
          <TargetFilename condition="end with">.lnk</TargetFilename>
        </Rule>

        <!-- (H) 사용자 프로파일 하위의 Run/Startup 경로 악성 Drop -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains any">
            \AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\;
            \AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\;
            \AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\
          </TargetFilename>
        </Rule>

      </FileBlockExecutable>
    </RuleGroup>

    <!-- EXCLUDE: 정상 소프트웨어 / 업데이트 / 패치 프로세스 등 허용 -->
    <RuleGroup name="Exclude_LegitActivity_Desktop" groupRelation="or">
      <FileBlockExecutable onmatch="exclude">

        <!-- (1) Microsoft Office 정식 설치 프로그램 -->
        <Rule groupRelation="and">
          <Image condition="contains">\Office\setup.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (2) Adobe Reader / Acrobat 설치 및 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="contains">\Adobe\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (3) Google Chrome / Edge WebView 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="contains any">\Google\Update\;\Google\Chrome\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (4) Microsoft Edge 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="contains">\Microsoft\EdgeUpdate\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (5) Zoom / WebEx / Teams 등 Collaboration 툴 -->
        <Rule groupRelation="and">
          <Image condition="contains">\zoom\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (6) Slack / Discord / 기타 Chat 클라이언트 -->
        <Rule groupRelation="and">
          <Image condition="contains">\Slack\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (7) Microsoft Visual Studio / .NET Installer -->
        <Rule groupRelation="and">
          <Image condition="contains">\Microsoft Visual Studio\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (8) .NET Framework / Windows Installer (MSI 기반) -->
        <Rule groupRelation="and">
          <Image condition="end with">msiexec.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (9) Windows Defender / AV 엔진 자체 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="contains">\ProgramData\Microsoft\Windows Defender\Platform\</Image>
          <TargetFilename condition="contains">\ProgramData\Microsoft\Windows Defender\</TargetFilename>
          <TargetFilename condition="contains any">\Definition Updates\;\Platform\</TargetFilename>
        </Rule>

		<!-- (9-1) Microsoft Defender 업데이트-->
		<Rule groupRelation="and">
          <Image condition="is">C:\WINDOWS\system32\MpSigStub.exe</Image>
          <TargetFilename condition="is">C:\Windows\Temp\</TargetFilename>
        </Rule>

        <!-- (10) Chrome / Edge 자체 Installer (예: ChromeSetup.exe 등) -->
        <Rule groupRelation="and">
          <Image condition="contains">\ChromeSetup.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (11) VSCode / JetBrains 제품군 설치 및 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="contains">\AppData\Local\Programs\Microsoft VS Code\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (12) JetBrains Toolbox / IntelliJ / PyCharm 등 -->
        <Rule groupRelation="and">
          <Image condition="contains">\JetBrains\Toolbox\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (13) Steam / 게임 런처 업데이트 (선택적으로 허용) -->
        <Rule groupRelation="and">
          <Image condition="contains">\Steam\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (14) NVIDIA / AMD 그래픽 드라이버 설치 프로그램 -->
        <Rule groupRelation="and">
          <Image condition="contains">\NVIDIA\</Image>
          <TargetFilename condition="contains">\Program Files\NVIDIA Corporation\Installer2\</TargetFilename>
        </Rule>

        <!-- (15) Windows Update 에이전트 일부 동작 허용 (필요 시) -->
        <Rule groupRelation="and">
          <Image condition="end with">wuauclt.exe</Image>
          <TargetFilename condition="contains">\SoftwareDistribution\Download\</TargetFilename>
        </Rule>

        <!-- (16) Chocolatey / Winget 등 패키지 관리자 (개발 환경에서 사용 시) -->
        <Rule groupRelation="and">
          <Image condition="contains">\chocolatey\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (17) Winget -->
        <Rule groupRelation="and">
          <Image condition="contains">\App Installer\</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- (18) CefSharp Unpacking -->
        <Rule groupRelation="and">
          <Image condition="end with">CefSharp.BrowserSubprocess.exe</Image>
          <TargetFilename condition="contains">\chrome_Unpacker_BeginUnzipping</TargetFilename>
        </Rule>
    
        <!-- (19) Visual Studio Installer -->
        <Rule groupRelation="and">
          <Image condition="begin with">C:\Program Files (x86)\Microsoft Visual Studio\Installer\</Image>
          <Image condition="end with">\Microsoft.VisualStudio.Setup.ServiceBackgroundDownload.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
          <TargetFilename condition="end with">vs_setup_bootstrapper.exe</TargetFilename>
        </Rule>

		<!-- (19-1) VS Code 업데이트 -->
        <Rule groupRelation="and">
          <Image condition="end with">\AppData\Local\Programs\Microsoft VS Code\Code.exe</Image>
          <TargetFilename condition="contains all">\AppData\Local\Temp\vscode-stable-user;\CodeSetup-stable-</TargetFilename>
        </Rule>
    
        <!-- (20) BITS tmp 파일 -->
        <Rule groupRelation="and">
          <Image condition="is">C:\WINDOWS\System32\svchost.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\BIT</TargetFilename>
        </Rule>
		
        <!-- (21) WinSCP 설치 프로그램 예외 -->
        <!-- 1단계: 설치 exe가 Temp 아래로 파일을 풀어낼 때 허용 -->
        <Rule groupRelation="and">
          <!-- 다운로드 폴더에서 실행되는 WinSCP 설치 파일 -->
          <Image condition="end with">WinSCP-6.5.5-Setup.exe</Image>
          <!-- 이 설치 파일이 AppData\Local\Temp 아래에 뭔가를 만들 때는 허용 -->
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- 2단계: Inno Setup가 만드는 is-xxxx.tmp 폴더 내 실행 허용 -->
        <Rule groupRelation="and">
          <Image condition="contains">WinSCP</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\is-</TargetFilename>
        </Rule>

		<!-- (22) Windows 배경화면 애플리케이션 업데이트 -->
		<Rule groupRelation="and">
          <Image condition="begin with">C:\Program Files\WindowsApps\Microsoft.BingWallpaper</Image>
          <Image condition="end with">BingWallpaper.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

		<!-- (23) OneDrive 패치 -->
		<Rule groupRelation="and">
          <Image condition="contains">\AppData\Local\Microsoft\OneDrive\</Image>
          <Image condition="end with">\OneDrivePatcher.exe</Image>
          <TargetFilename condition="contains all">\AppData\Local\Temp\;\OneDriveDeltaPatch\</TargetFilename>
        </Rule>

		<!-- (24) ALToolsManager 업데이트 -->
		<Rule groupRelation="and">
          <Image condition="is">C:\Program Files (x86)\ESTsoft\ALToolsManager\ALToolsManager.exe</Image>
          <TargetFilename condition="contains">\AppData\Roaming\ESTsoft\ALToolsManager\</TargetFilename>
        </Rule>

		<!-- (25) Windows Update 플랫폼이 업데이트 준비 과정에서 생성하는 정상 DLL -->
		<Rule groupRelation="and">
          <Image condition="begin with">C:\WINDOWS\SoftwareDistribution\Download\</Image>
          <Image condition="end with">\InstallUpdatePlatform.amd64fre.exe</Image>
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
        </Rule>

		<!-- sysmon 업데이트 시, 임시 경로에 자신의 복사본을 만들고 작업을 수행 -->
		<Rule groupRelation="and">
          <Image condition="is">C:\Program Files\PLURA\Sysmon.exe</Image>
          <Image condition="end with">\AppData\Local\Temp\Sysmon.exe</Image>
        </Rule>
		  
      </FileBlockExecutable>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
