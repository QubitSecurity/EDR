<!-- NOTICE: PLURA Sysmon Configuration File Version 1.7 (Server) -->
<!-- DOWNLOAD: https://learn.microsoft.com/ko-kr/sysinternals/downloads/sysmon -->
<!-- INSTALL: sysmon -accepteula -i "C:\Program Files (x86)\PLURA\sysmon-plura-v1.7-server.xml" -->
<!-- UPDATE: sysmon -c "C:\Program Files (x86)\PLURA\sysmon-plura-v1.7-server.xml" -->
<!-- DELETE: sysmon -u force -->
<!-- Sysmon v14.14 (2023.01.25) -->

<Sysmon schemaversion="4.83">
  <!-- META CONFIG -->
  <HashAlgorithms>*</HashAlgorithms>
  <!-- CheckRevocation: False 로 설정하여 드라이버 서명 폐기 조회 비활성화 (성능 영향 감소) -->
  <CheckRevocation>False</CheckRevocation>
  <!-- DnsLookup: False 로 설정하여 Sysmon 자체 DNS 역조회 비활성화 (성능/지연 감소) -->
  <DnsLookup>False</DnsLookup>
  <!-- ArchiveDirectory: C:\Sysmon\ 아래에 보존 파일 저장 (필요 시 별도 파티션/정리 스크립트와 연계) -->
  <ArchiveDirectory>Sysmon</ArchiveDirectory>

  <EventFiltering>
	
  <!-- EVENT ID 1 : PROCESS CREATION [ProcessCreate] -->
  <!--DATA: UtcTime, ProcessGuid, ProcessID, Image, FileVersion, Description, Product, Company, CommandLine, CurrentDirectory, User, LogonGuid, LogonId, TerminalSessionId, IntegrityLevel, Hashes, ParentProcessGuid, ParentProcessId, ParentImage, ParentCommandLine, RuleName-->
  <ProcessCreate onmatch="exclude">
    <!-- v1.7 서버용: 일단 전체 수집, 추후 환경별로 제외 룰 추가 예정 -->
  </ProcessCreate>
 
  <!-- EVENT ID 2 : FILE CREATION TIME [FileCreateTime] -->
  <!-- Cannot be filtered. -->

  <!-- EVENT ID 3 : NETWORK CONNECTION [NetworkConnect] -->
  <NetworkConnect onmatch="exclude">
    <!-- PLURA 에이전트 통신은 제외 -->
    <Image condition="begin with">C:\Program Files (x86)\PLURA\</Image>
  </NetworkConnect>
	
  <!-- EVENT ID 4 : SYSMON SERVICE STATUS -->
  <!-- Cannot be filtered. -->
		
  <!-- EVENT ID 5 : PROCESS TERMINATED [ProcessTerminate] -->
  <ProcessTerminate onmatch="exclude">
    <!-- 서버 포렌식을 위해 기본적으로 전체 수집 -->
  </ProcessTerminate>

  <!-- EVENT ID 6 : DRIVER LOADED [DriverLoad] -->
  <!-- Cannot be filtered. -->

  <!-- EVENT ID 7 : IMAGE LOADED [ImageLoad] -->
  <RuleGroup name="" groupRelation="or">
    <ImageLoad onmatch="include">
      <ImageLoaded condition="Contains">System.Reflection.Dll</ImageLoaded>
      <ImageLoaded condition="Contains">System.Management.Automation.Dll</ImageLoaded>
      <ImageLoaded condition="Contains">System.Management.Automation.ni.Dll</ImageLoaded>
    </ImageLoad>
  </RuleGroup>

  <!-- EVENT ID 8 : REMOTE THREAD CREATED [CreateRemoteThread] -->
  <!-- Cannot be filtered. -->	
	
  <!-- EVENT ID 9 : RAW DISK ACCESS [RawAccessRead] -->
  <!-- Cannot be filtered. -->
	
  <!-- EVENT ID 10 : PROCESS ACCESS [ProcessAccess] -->
  <!-- Cannot be filtered. -->
	
  <!-- EVENT ID 11 : FILE CREATED [FileCreate] -->
  <RuleGroup name="" groupRelation="or">
    <FileCreate onmatch="include">
      <TargetFilename condition="contains">\Start Menu</TargetFilename> 
      <TargetFilename condition="contains">\Startup\</TargetFilename>
      <TargetFilename condition="contains">\Content.Outlook\</TargetFilename> 
      <TargetFilename condition="contains">\Downloads\</TargetFilename> 
      <TargetFilename condition="end with">.application</TargetFilename> 
      <TargetFilename condition="end with">.appref-ms</TargetFilename>
      <TargetFilename condition="end with">.bat</TargetFilename> 
      <TargetFilename condition="end with">.chm</TargetFilename>
      <TargetFilename condition="end with">.cmd</TargetFilename>
      <TargetFilename condition="end with">.cmdline</TargetFilename> 
      <TargetFilename condition="end with">.crx</TargetFilename> 
      <TargetFilename condition="end with">.dmp</TargetFilename> 
      <TargetFilename condition="end with">.docm</TargetFilename>
      <TargetFilename condition="end with">.dll</TargetFilename>
      <TargetFilename condition="end with">.exe</TargetFilename> 
      <TargetFilename condition="end with">.exe.log</TargetFilename>  
      <TargetFilename condition="end with">.jar</TargetFilename> 
      <TargetFilename condition="end with">.jnlp</TargetFilename>
      <TargetFilename condition="end with">.jse</TargetFilename>
      <TargetFilename condition="end with">.hta</TargetFilename> 
      <TargetFilename condition="end with">.job</TargetFilename> 
      <TargetFilename condition="end with">.pptm</TargetFilename> 
      <TargetFilename condition="end with">.ps1</TargetFilename>
      <TargetFilename condition="end with">.sys</TargetFilename>
      <TargetFilename condition="end with">.scr</TargetFilename>
      <TargetFilename condition="end with">.vbe</TargetFilename>
      <TargetFilename condition="end with">.vbs</TargetFilename>
      <TargetFilename condition="end with">.xlsm</TargetFilename>
      <TargetFilename condition="end with">proj</TargetFilename>
      <TargetFilename condition="end with">.sln</TargetFilename>

      <TargetFilename condition="begin with">C:\Users\Default</TargetFilename> 
      <TargetFilename condition="begin with">C:\Windows\system32\Drivers</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\Drivers</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\GroupPolicy\Machine\Scripts</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\GroupPolicy\User\Scripts</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\Wbem</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\Wbem</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\WindowsPowerShell</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\WindowsPowerShell</TargetFilename>

      <!-- PLURA 중요 파일 -->
      <TargetFilename condition="begin with">C:\Windows\System32\drivers\etc\hosts</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\winevt\Logs</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\config\SAM</TargetFilename>
      <TargetFilename condition="begin with">C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</TargetFilename>
      <TargetFilename condition="begin with">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</TargetFilename>
      <TargetFilename condition="begin with">C:\Users\Administrator</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\Tasks\</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\Tasks</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\Tasks</TargetFilename>

      <!-- 환경변수 기반 경로를 실제 경로/패턴으로 보완 -->
      <TargetFilename condition="begin with">C:\Windows\system32\</TargetFilename>
      <TargetFilename condition="begin with">C:\Users\Default\</TargetFilename>
      <TargetFilename condition="contains">\AppData\Roaming\</TargetFilename>
      <TargetFilename condition="contains">\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</TargetFilename>
      <TargetFilename condition="begin with">C:\Program Files\Common Files\</TargetFilename>
      <TargetFilename condition="begin with">C:\Program Files (x86)\Common Files</TargetFilename>

      <!-- 섀도우 카피 접근 -->
      <TargetFilename condition="contains">\Device\HarddiskVolumeShadowCopy</TargetFilename>

      <!--Windows application compatibility-->
      <TargetFilename condition="begin with">C:\Windows\AppPatch\Custom</TargetFilename> 
      <TargetFilename condition="contains">VirtualStore</TargetFilename> 
      <!--Exploitable file names-->
      <TargetFilename condition="end with">.xls</TargetFilename> 
      <TargetFilename condition="end with">.ppt</TargetFilename> 
      <TargetFilename condition="end with">.rtf</TargetFilename>
    </FileCreate>
  </RuleGroup>

  <RuleGroup name="" groupRelation="or">
    <FileCreate onmatch="exclude">
      <!--SECTION: Microsoft-->
      <Image condition="is">C:\Program Files (x86)\EMET 5.5\EMET_Service.exe</Image> 
      <!--SECTION: Microsoft:Office:Click2Run-->
      <Image condition="is">C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe</Image>
      <!--SECTION: Windows-->
      <Image condition="is">C:\Windows\system32\smss.exe</Image>
      <Image condition="is">C:\Windows\system32\CompatTelRunner.exe</Image>
      <Image condition="is">\\?\C:\Windows\system32\wbem\WMIADAP.EXE</Image> 
      <Image condition="is">C:\Windows\system32\mobsync.exe</Image>
      <TargetFilename condition="begin with">C:\Windows\system32\DriverStore\Temp\</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\system32\wbem\Performance\</TargetFilename> 
      <TargetFilename condition="begin with">C:\Windows\Installer\</TargetFilename> 
      <!--SECTION: Windows:Updates-->
      <TargetFilename condition="begin with">C:\$WINDOWS.~BT\Sources\</TargetFilename> 
      <Image condition="begin with">C:\Windows\winsxs\amd64_microsoft-windows</Image> 
      <Image condition="begin with">C:\Program files (x86)\PLURA</Image>
    </FileCreate>
  </RuleGroup>

  <!-- EVENT ID 12/13/14 : REGISTRY MODIFICATION [RegistryEvent] -->
  <RuleGroup name="" groupRelation="or">
    <RegistryEvent onmatch="include">		
      <TargetObject condition="contains">Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run</TargetObject>
      <TargetObject condition="contains">SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</TargetObject> 
      <TargetObject condition="contains">Software\Microsoft\Active Setup\Installed Components</TargetObject> 
      <TargetObject condition="contains">SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject> 
      <TargetObject condition="contains">\Software\Wow6432Node\Microsoft\Active Setup\Installed Components</TargetObject> 
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\services\USBSTOR</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\batfile\shell\print\command</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\batfile\shell\runas\command</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\cmdfile\shell\print\command</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\cmdfile\shell\runas\command</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\cmdfile\shellex\ContextMenuHandlers\Compatibility</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\Directory\shell\cmd\command</TargetObject>  
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\exefile\shell\runas\command</TargetObject> 
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\exefile\shellex\ContextMenuHandlers\Compatibility</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\NOHIDDEN</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\HideFileExt</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\SuperHidden</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\ControlSet002\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Defaults\FirewallPolicy\StandardProfile\Logging</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\services\SharedAccess\Parameters\FirewallPolicy\StandardProfile</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot</TargetObject>
      <TargetObject condition="contains">HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\ControlSet001\services\USBSTOR</TargetObject>
      <TargetObject condition="contains">SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\batfile\shell\edit\command</TargetObject>		
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\cmdfile\shell\open\command</TargetObject>		
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\comfile\shell\open\command</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\Directory\background\shell\cmd\command</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\exefile\shell\open\command</TargetObject>		
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\Folder\shell\open\command</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\htafile\shell\open\command</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Classes\mscfile\shell\open\command</TargetObject>		
      <TargetObject condition="contains">SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced</TargetObject>		
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\URL\DefaultPrefix</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\ControlSet001\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile</TargetObject>		
      <TargetObject condition="contains">HKLM\SYSTEM\ControlSet001\Control\SafeBoot</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Services\wscsvc\Parameters</TargetObject>
      <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Services\RemoteAccess\RouterManagers\Ip</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\SystemCertificates\AuthRoot\Certificates\DAC9024F54D8F6DF94935FB1732638CA6AD77C13</TargetObject>
      <TargetObject condition="contains">Software\Microsoft\Windows\CurrentVersion\Internet Settings</TargetObject>
      <TargetObject condition="contains">Control Panel\Desktop</TargetObject>
      <TargetObject condition="contains">Software\Microsoft\Internet Explorer\TypedURLs</TargetObject>
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\Folders</TargetObject>		
    </RegistryEvent>
  </RuleGroup>

  <!-- EVENT ID 15 : FILE CREATE STREAM HASH [FileCreateStreamHash] -->
  <!-- Cannot be filtered. -->

  <!-- EVENT ID 16 : CONFIGURATION CHANGE -->
  <!-- Cannot be filtered. -->

  <!-- EVENT ID 17 & 18 : PIPE CREATED / PIPE CONNECTED [PipeEvent] -->
  <!-- Cannot be filtered. -->
		
  <!-- EVENT ID 19/20/21 : WMI EVENT [WmiEvent] -->
  <!-- Cannot be filtered. -->

  <!-- EVENT ID 22 : DNS QUERY [DnsQuery] -->
  <!-- PowerShell/LOLBin 기반 의심 DNS 쿼리 수집 -->
  <DnsQuery onmatch="include">
    <Image condition="end with">powershell.exe</Image>
    <Image condition="end with">pwsh.exe</Image>
    <Image condition="end with">cmd.exe</Image>
    <Image condition="end with">wscript.exe</Image>
    <Image condition="end with">cscript.exe</Image>
    <Image condition="end with">mshta.exe</Image>
    <Image condition="end with">regsvr32.exe</Image>
    <Image condition="end with">rundll32.exe</Image>
  </DnsQuery>

  <!-- ⚠ NOTE: Event ID 27 (FileBlockExecutable) 은 v1.7 서버용 구성에서 제외됨 -->
  <!-- 차단 정책은 별도 sysmon-27-plura-server.xml 로 관리 -->

  </EventFiltering>
</Sysmon>
