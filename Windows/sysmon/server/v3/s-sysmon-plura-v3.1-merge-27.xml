<!-- PLURA_CONFIG_VERSION: s-sysmon-plura-v3.1-merge-27.xml --> 
<!-- PLURA_SCHEMA_TARGET: 4.90 -->

<Sysmon schemaversion="4.90">
  <HashAlgorithms>*</HashAlgorithms>
  <CheckRevocation>False</CheckRevocation>
  <DnsLookup>False</DnsLookup>
  <ArchiveDirectory>Sysmon</ArchiveDirectory>

  <EventFiltering>

    <!-- ============================================================ -->
    <!-- Event ID 1: Process Create (서버 핵심 프로세스 중심) -->
    <!-- ============================================================ -->

    <RuleGroup name="ProcessCreate-Exclude-Noise" groupRelation="or">
      <ProcessCreate onmatch="exclude">
        <!-- PLURA Agent / Tools -->
        <ParentImage condition="end with">\Program Files (x86)\PLURA\PLURAService.exe</ParentImage>
        <ParentImage condition="end with">\Program Files (x86)\PLURA\PLURASControl.exe</ParentImage>
        <ParentImage condition="end with">\Program Files (x86)\PLURA\PLURAConfig.exe</ParentImage>
        <ParentImage condition="end with">\Program Files (x86)\PLURA\PLURATray.exe</ParentImage>

        <!-- Windows common noise -->
        <Image condition="end with">\Windows\System32\RuntimeBroker.exe</Image>
        <Image condition="end with">\Windows\System32\backgroundTaskHost.exe</Image>

        <!-- .NET ngen / mscorsvw compilation noise -->
        <CommandLine condition="begin with">C:\Windows\Microsoft.NET\Framework\v4.0.30319\ngen.exe</CommandLine>
        <Image condition="is">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe</Image>
        <Image condition="is">C:\Windows\Microsoft.NET\Framework\v4.0.30319\mscorsvw.exe</Image>
      </ProcessCreate>
    </RuleGroup>

    <RuleGroup name="ProcessCreate-Include-Server" groupRelation="or">
      <ProcessCreate onmatch="include">

        <!-- PowerShell / Script engines -->
        <Image condition="end with">\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Image>
        <Image condition="end with">\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe</Image>
        <Image condition="end with">\Windows\System32\pwsh.exe</Image>
        <Image condition="end with">\Windows\System32\cscript.exe</Image>
        <Image condition="end with">\Windows\System32\wscript.exe</Image>
        <Image condition="end with">\Windows\System32\mshta.exe</Image>
        <Image condition="end with">\Windows\System32\rundll32.exe</Image>
        <Image condition="end with">\Windows\System32\regsvr32.exe</Image>
        <Image condition="end with">\Windows\System32\cmd.exe</Image>

        <!-- Remote admin tools / lateral movement utilities -->
        <Image condition="end with">\Windows\System32\psexec.exe</Image>
        <Image condition="end with">\Windows\System32\wmic.exe</Image>
        <Image condition="end with">\Windows\System32\net.exe</Image>
        <Image condition="end with">\Windows\System32\net1.exe</Image>
        <Image condition="end with">\Windows\System32\sc.exe</Image>
        <Image condition="end with">\Windows\System32\schtasks.exe</Image>

        <!-- IIS / Web stack -->
        <Image condition="end with">\Windows\System32\inetsrv\w3wp.exe</Image>
        <Image condition="end with">\Windows\System32\inetsrv\appcmd.exe</Image>
        <Image condition="end with">\Windows\System32\inetsrv\iisreset.exe</Image>
        <Image condition="end with">\Windows\System32\inetsrv\inetinfo.exe</Image>

        <!-- SQL Server -->
        <Image condition="end with">\MSSQL\Binn\sqlservr.exe</Image>
        <Image condition="contains">\Microsoft SQL Server\</Image>

        <!-- LOLBAS downloaders -->
        <Image condition="end with">\Windows\System32\certutil.exe</Image>
        <Image condition="end with">\Windows\System32\bitsadmin.exe</Image>
        <Image condition="end with">\Windows\System32\curl.exe</Image>
        <Image condition="end with">\Windows\System32\wget.exe</Image>

        <!-- Suspicious execution locations on servers -->
        <Rule groupRelation="and">
          <Image condition="contains">\Windows\Temp\</Image>
        </Rule>
        <Rule groupRelation="and">
          <Image condition="contains">\ProgramData\</Image>
        </Rule>
      </ProcessCreate>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 3: Network Connect -->
    <!-- ============================================================ -->
    <RuleGroup name="NetworkConnect-Exclude-Noise" groupRelation="or">
      <NetworkConnect onmatch="exclude">
        <!-- PLURA -->
        <Image condition="contains">:\Program Files (x86)\PLURA\</Image>
        <DestinationHostname condition="is">ns.plura.io</DestinationHostname>
        <DestinationHostname condition="is">apis.plura.io</DestinationHostname>

        <!-- Multicast / loopback -->
        <SourceIp condition="begin with">224.0.0.</SourceIp>
        <SourceIp condition="begin with">ff02:0:0:0:0:0:1:</SourceIp>
        <SourceIp condition="is">239.255.255.250</SourceIp>
        <SourceIp condition="is">0:0:0:0:0:0:0:1</SourceIp>
        <DestinationIp condition="is">239.255.255.250</DestinationIp>
        <DestinationIp condition="is">0:0:0:0:0:0:0:1</DestinationIp>

        <!-- Windows Update / Microsoft -->
        <DestinationHostname condition="end with">.windowsupdate.microsoft.com</DestinationHostname>
        <DestinationHostname condition="end with">.windowsupdate.com</DestinationHostname>
        <DestinationHostname condition="end with">wustat.windows.com</DestinationHostname>
        <DestinationHostname condition="end with">go.microsoft.com</DestinationHostname>
        <DestinationHostname condition="end with">.update.microsoft.com</DestinationHostname>
        <DestinationHostname condition="end with">download.microsoft.com</DestinationHostname>
      </NetworkConnect>
    </RuleGroup>

    <RuleGroup name="NetworkConnect-Include-Server" groupRelation="or">
      <NetworkConnect onmatch="include">
        <Image condition="end with">\Windows\System32\inetsrv\w3wp.exe</Image>
        <Image condition="end with">\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Image>
        <Image condition="end with">\Windows\System32\pwsh.exe</Image>
        <DestinationPort condition="is">3389</DestinationPort>
        <DestinationPort condition="is">445</DestinationPort>
        <DestinationPort condition="is">5985</DestinationPort>
        <DestinationPort condition="is">5986</DestinationPort>
      </NetworkConnect>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 5: Process Terminate -->
    <!-- ============================================================ -->
    <RuleGroup name="ProcessTerminate-Exclude-Noise" groupRelation="or">
      <ProcessTerminate onmatch="exclude">
        <Image condition="end with">\Windows\System32\backgroundTaskHost.exe</Image>
        <Image condition="end with">\Windows\System32\RuntimeBroker.exe</Image>
        <Image condition="end with">\Sysmon\Sysmon64.exe</Image>
        <Image condition="end with">\Sysmon\Sysmon.exe</Image>
      </ProcessTerminate>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 7: ImageLoad (PowerShell) -->
    <!-- ============================================================ -->
    <RuleGroup name="ImageLoad-PowerShell" groupRelation="and">
      <ImageLoad onmatch="include">
        <Rule groupRelation="or">
          <ImageLoaded condition="contains">System.Management.Automation</ImageLoaded>
          <ImageLoaded condition="contains">System.Reflection</ImageLoaded>
          <ImageLoaded condition="contains">sspisrv.dll</ImageLoaded>
        </Rule>
      </ImageLoad>
      <ImageLoad onmatch="exclude">
        <Rule groupRelation="or">
          <Image condition="end with">\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe</Image>
          <Image condition="end with">\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Image>
          <Image condition="end with">\Windows\System32\WindowsPowerShell\v1.0\powershell_ise.exe</Image>
        </Rule>
      </ImageLoad>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 9: RawAccessRead -->
    <!-- ============================================================ -->
    <RuleGroup name="RawAccessRead-Server" groupRelation="and">
      <RawAccessRead onmatch="include">
        <Device condition="contains">\Device\Harddisk0\DR0</Device>
      </RawAccessRead>
      <RawAccessRead onmatch="exclude">
        <Rule groupRelation="or">
          <Image condition="contains all">\ProgramData\Microsoft\Windows Defender\platform\;\MsMpEng.exe</Image>
          <Image condition="contains">\Windows\System32\</Image>
          <Image condition="contains">\Windows\SysWOW64\</Image>
        </Rule>
      </RawAccessRead>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 11: FileCreate (서버 핵심 경로 중심) -->
    <!-- ============================================================ -->
    <RuleGroup name="FileCreate-Include-ServerCore" groupRelation="or">
      <FileCreate onmatch="include">
        <TargetFilename condition="begin with">C:\Windows\System32\drivers\etc\hosts</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\System32\winevt\Logs</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\System32\config\SAM</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Tasks\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\System32\Tasks\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\SysWOW64\Tasks\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\System32\GroupPolicy\Machine\Scripts</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\System32\GroupPolicy\User\Scripts</TargetFilename>

        <!-- IIS -->
        <TargetFilename condition="begin with">C:\inetpub\wwwroot\</TargetFilename>
        <TargetFilename condition="contains">\Windows\System32\inetsrv\config</TargetFilename>

        <!-- SQL Server -->
        <TargetFilename condition="contains all">C:\Program Files\Microsoft SQL Server;\Shared\ErrorDumps</TargetFilename>
        <TargetFilename condition="contains all">C:\Program Files\Microsoft SQL Server;\DataDumps</TargetFilename>
        <TargetFilename condition="contains">\Microsoft SQL Server\</TargetFilename>

        <!-- Suspicious drop locations -->
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd;.scr;.sys</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\ProgramData\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd;.scr;.sys</TargetFilename>
        </Rule>
      </FileCreate>
    </RuleGroup>

    <RuleGroup name="FileCreate-Exclude-PLURA" groupRelation="or">
      <FileCreate onmatch="exclude">
        <Image condition="end with">\Program Files (x86)\PLURA\PLURAService.exe</Image>
        <Image condition="end with">\Program Files (x86)\PLURA\PLURASControl.exe</Image>
        <Image condition="end with">\Program Files (x86)\PLURA\PLURAConfig.exe</Image>
        <Image condition="end with">\Program Files (x86)\PLURA\PLURATray.exe</Image>
      </FileCreate>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 12/13/14: RegistryEvent -->
    <!-- ============================================================ -->
    <RuleGroup name="RegistryEvent-Include-ServerCore" groupRelation="or">
      <RegistryEvent onmatch="include">
        <TargetObject condition="contains">\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">\Policies\Explorer\Run</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</TargetObject>
        <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</TargetObject>
        <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Services\</TargetObject>

        <TargetObject condition="contains">HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription</TargetObject>

        <TargetObject condition="contains">\Control\Lsa\</TargetObject>
        <TargetObject condition="contains">\Control\SecurityProviders\WDigest</TargetObject>

        <TargetObject condition="contains all">\SYSTEM\;\Service\EventLog;Retention</TargetObject>
        <TargetObject condition="contains all">\SYSTEM\;\Service\EventLog;MaxSize</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <RuleGroup name="RegistryEvent-Exclude-PLURA-Noise" groupRelation="or">
      <RegistryEvent onmatch="exclude">
        <Image condition="contains all">\Program Files\Common Files\Microsoft Shared\ClickToRun\Updates\;\OfficeClickToRun.exe</Image>
        <Image condition="begin with">C:\Program Files (x86)\PLURA\</Image>
        <Image condition="begin with">C:\Program Files\PLURA\</Image>
      </RegistryEvent>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 15: FileCreateStreamHash -->
    <!-- ============================================================ -->
    <RuleGroup name="FileCreateStreamHash-Server" groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <Rule name="ZoneIdentifier" groupRelation="and">
          <TargetFilename condition="end with">:Zone.Identifier</TargetFilename>
          <Contents condition="contains any">about:internet;blob:</Contents>
        </Rule>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.psm1</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 22: DNS Query (IOC 예시) -->
    <!-- ============================================================ -->
    <RuleGroup name="DnsQuery-IOC" groupRelation="or">
      <DnsQuery onmatch="include">
        <QueryName condition="end with">tcjst.com</QueryName>
      </DnsQuery>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 23/26: FileDelete / FileDeleteDetected -->
    <!-- ============================================================ -->
    <RuleGroup name="FileDelete-ArchivedCopy-Disabled" groupRelation="or">
      <FileDelete onmatch="exclude" />
    </RuleGroup>

    <RuleGroup name="FileDeleteDetected-Include-ServerCore" groupRelation="or">
      <FileDeleteDetected onmatch="include">
        <TargetFilename condition="contains all">C:\Program Files\Microsoft SQL Server;\Shared\ErrorDumps</TargetFilename>
        <TargetFilename condition="contains all">C:\Program Files\Microsoft SQL Server;\DataDumps</TargetFilename>

        <Rule groupRelation="and">
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd;.scr;.sys;.msi</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\ProgramData\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd;.scr;.sys;.msi</TargetFilename>
        </Rule>
      </FileDeleteDetected>
    </RuleGroup>

    <RuleGroup name="FileDeleteDetected-Exclude-CommonNoise" groupRelation="or">
      <FileDeleteDetected onmatch="exclude">
        <Image condition="contains all">\appdata\local\google\chrome\user data\swreporter\;software_reporter_tool.exe</Image>
        <User condition="contains any">NETWORK SERVICE; LOCAL SERVICE</User>
      </FileDeleteDetected>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 8: CreateRemoteThread -->
    <!-- ============================================================ -->
    <RuleGroup name="CreateRemoteThread-Include" groupRelation="or">
      <CreateRemoteThread onmatch="include">
        <SourceImage condition="begin with">C:\</SourceImage>
        <SourceImage condition="begin with">\\</SourceImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- ============================================================ -->
    <!-- Event ID 27: FileBlockExecutable (Server-tailored merge) -->
    <!-- ============================================================ -->

    <RuleGroup name="FileBlockExecutable-Include-Server" groupRelation="or">
      <FileBlockExecutable onmatch="include">

        <!-- Temp/ProgramData: executables created in writable locations are high-risk -->
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.sys;.scr;.msi;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd</TargetFilename>
        </Rule>

        <Rule groupRelation="and">
          <TargetFilename condition="contains">\ProgramData\</TargetFilename>
          <TargetFilename condition="contains any">.exe;.dll;.sys;.scr;.msi;.ps1;.vbs;.js;.jse;.hta;.bat;.cmd</TargetFilename>
        </Rule>

        <!-- IIS webroot drops -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\inetpub\wwwroot\</TargetFilename>
          <TargetFilename condition="contains any">.aspx;.ashx;.asmx;.php;.jsp;.jspx;.war;.jar;.exe;.dll</TargetFilename>
        </Rule>

        <!-- GPO scripts / Tasks drops -->
        <Rule groupRelation="and">
          <TargetFilename condition="contains">\GroupPolicy\</TargetFilename>
          <TargetFilename condition="contains any">.ps1;.vbs;.js;.bat;.cmd</TargetFilename>
        </Rule>

        <Rule groupRelation="and">
          <TargetFilename condition="contains">\System32\Tasks\</TargetFilename>
          <TargetFilename condition="contains any">.ps1;.vbs;.js;.bat;.cmd;.exe</TargetFilename>
        </Rule>

        <!-- LOLBAS binaries dropped into unusual folders -->
        <Rule groupRelation="or">
          <TargetFilename condition="end with">\powershell.exe</TargetFilename>
          <TargetFilename condition="end with">\pwsh.exe</TargetFilename>
          <TargetFilename condition="end with">\mshta.exe</TargetFilename>
          <TargetFilename condition="end with">\wscript.exe</TargetFilename>
          <TargetFilename condition="end with">\cscript.exe</TargetFilename>
          <TargetFilename condition="end with">\rundll32.exe</TargetFilename>
          <TargetFilename condition="end with">\regsvr32.exe</TargetFilename>
          <TargetFilename condition="end with">\certutil.exe</TargetFilename>
          <TargetFilename condition="end with">\bitsadmin.exe</TargetFilename>
        </Rule>

      </FileBlockExecutable>
    </RuleGroup>

    <RuleGroup name="FileBlockExecutable-Exclude-ServerLegit" groupRelation="or">
      <FileBlockExecutable onmatch="exclude">

        <!-- Windows Update / Servicing -->
        <Rule groupRelation="and">
          <Image condition="end with">\TrustedInstaller.exe</Image>
          <TargetFilename condition="contains">\Windows\WinSxS\</TargetFilename>
        </Rule>

        <Rule groupRelation="and">
          <Image condition="end with">\TiWorker.exe</Image>
          <TargetFilename condition="contains">\Windows\WinSxS\</TargetFilename>
        </Rule>

        <Rule groupRelation="and">
          <Image condition="end with">\wuauclt.exe</Image>
          <TargetFilename condition="contains">\SoftwareDistribution\Download\</TargetFilename>
        </Rule>

        <Rule groupRelation="and">
          <Image condition="end with">\svchost.exe</Image>
          <TargetFilename condition="contains">\SoftwareDistribution\</TargetFilename>
        </Rule>

        <!-- MSI installations -->
        <Rule groupRelation="and">
          <Image condition="end with">msiexec.exe</Image>
          <TargetFilename condition="contains">\Windows\Installer\</TargetFilename>
        </Rule>

        <!-- Common enterprise agents updating in ProgramData -->
        <Rule groupRelation="and">
          <Image condition="contains">\Program Files\Amazon\Ec2ConfigService\</Image>
          <TargetFilename condition="contains">\ProgramData\</TargetFilename>
        </Rule>

        <!-- SQL Server patching / maintenance -->
        <Rule groupRelation="and">
          <Image condition="contains">\Microsoft SQL Server\</Image>
          <TargetFilename condition="contains">\Microsoft SQL Server\</TargetFilename>
        </Rule>

        <!-- IIS / WebDeploy / AppHost config updates -->
        <Rule groupRelation="and">
          <Image condition="contains">\Windows\System32\inetsrv\</Image>
          <TargetFilename condition="contains">\Windows\System32\inetsrv\</TargetFilename>
        </Rule>

        <!-- PLURA operations -->
        <Rule groupRelation="and">
          <Image condition="contains">\Program Files (x86)\PLURA\</Image>
          <TargetFilename condition="contains">\Program Files (x86)\PLURA\</TargetFilename>
        </Rule>

      </FileBlockExecutable>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
