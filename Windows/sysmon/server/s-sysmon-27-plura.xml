<!-- PLURA Sysmon 27 Server -->

<Sysmon schemaversion="4.90">
  <EventFiltering>

    <!-- SYSMON EVENT ID 27 : FILE BLOCK EXECUTABLE [FileBlockExecutable] - Server (보수적 적용) -->

    <!-- INCLUDE: 악성 Drop/Run 경로 (서버에 맞게 보수적으로) -->
    <RuleGroup name="Include_MalwareDrop_Server" groupRelation="or">
      <FileBlockExecutable onmatch="include">

        <!-- (A) 사용자 데이터 보호 (Honeypot) -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains any">
            \Documents\;
            \Pictures\;
            \Videos\;
            \Music\;
            \Favorites\;
            \Client_Contracts\
          </TargetFilename>
        </Rule>

        <!-- (B) 일반적 임시경로 (C:\Temp, C:\Windows\Temp) -->
        <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>

        <!-- (C) Office 체인 → Temp/Roaming EXE 생성 시 차단 -->
        <Rule groupRelation="and">
          <Image condition="contains any">
            OUTLOOK.exe;
            WINWORD.exe;
            POWERPNT.exe;
            EXCEL.exe;
            VISIO.exe;
            MSACCESS.exe;
            MSPUB.exe;
            EQNEDT32.exe;
            TEAMS.exe;
            LYNC.exe
          </Image>
          <TargetFilename condition="contains any">
            \Temp\;
            \AppData\Local\Temp\;
            \AppData\Roaming\
          </TargetFilename>
        </Rule>

        <!-- (D) ZIP 기반 랜섬웨어 Drop (7z.exe 사용) -->
        <Rule groupRelation="and">
          <Image condition="end with">7z.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- 서버에서는 PowerShell/LOLBin의 Temp/ProgramData 전역 차단은 제외 -->

      </FileBlockExecutable>
    </RuleGroup>

    <!-- EXCLUDE: 정상 설치/업데이트/보안솔루션/개발 환경 예외 -->
    <RuleGroup name="Exclude_LegitActivity_Server" groupRelation="or">
      <FileBlockExecutable onmatch="exclude">

        <!-- (1) Outlook/Office 정상 임시 파일 -->
        <TargetFilename condition="contains">Content.Outlook\</TargetFilename>
        <TargetFilename condition="contains">Content.MSO\</TargetFilename>
        <TargetFilename condition="end with">MSForms.exd</TargetFilename>
        <TargetFilename condition="contains">~$</TargetFilename>

        <!-- (2) 정상 다운로드 폴더 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Downloads\</TargetFilename>
        </Rule>

        <!-- (3) PowerShell Profile 업데이트 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Documents\WindowsPowerShell\</TargetFilename>
        </Rule>

        <!-- (4) Windows Installer / Update -->
        <Image condition="is">C:\Windows\System32\msiexec.exe</Image>
        <Image condition="is">C:\Windows\servicing\TrustedInstaller.exe</Image>
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>
        <Image condition="is">C:\Windows\System32\dism.exe</Image>
        <Image condition="is">C:\Windows\System32\wusa.exe</Image>
        <Image condition="is">C:\Windows\System32\cleanmgr.exe</Image>
        <Image condition="is">C:\Windows\System32\wuauclt.exe</Image>

        <!-- (5) Windows 오류보고/진단 -->
        <Image condition="is">C:\Windows\System32\werfault.exe</Image>
        <Image condition="is">C:\Windows\System32\wermgr.exe</Image>

        <!-- (6) Windows CAB/압축 관련 -->
        <Image condition="is">C:\Windows\System32\makecab.exe</Image>
        <Image condition="is">C:\Windows\System32\iexpress.exe</Image>

        <!-- (7) 보안 솔루션 필수 예외 -->
        <Image condition="contains any">
          C:\ProgramData\Microsoft\Windows Defender\Platform\;
          MsMpEng.exe
        </Image>
        <Image condition="end with">MpSigStub.exe</Image>
        <Image condition="end with">NisSrv.exe</Image>
        <Image condition="end with">Sysmon.exe</Image>

        <!-- (8) Python 개발 환경 (필요 시 서버에 맞게 조정) -->
        <Image condition="contains">\venv\Scripts\python.exe</Image>
        <Image condition="contains">\python.exe</Image>
        <Image condition="contains">\pip.exe</Image>

        <!-- (9) 기타 자동 업데이트/에이전트 (환경에 맞게 추가/조정) -->
        <Image condition="contains any">
          msedge.exe;
          Squirrel.exe;
          Update.exe;
          Discord.exe;
          Teams.exe;
          Zoom.exe
        </Image>
        <Rule groupRelation="and">
          <Image condition="is">C:\Program Files\Google\Chrome\Application\chrome.exe</Image>
        </Rule>

        <Image condition="contains any">
          agent;
          updater;
          backup;
          monitor
        </Image>

        <Image condition="end with">OneDrive.exe</Image>

        <!-- (10) Windows Troubleshooter -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\System32\taskhostw.exe</Image>
          <TargetFilename condition="begin with">C:\Windows\Temp\SDIAG_</TargetFilename>
          <TargetFilename condition="contains any">.dll;.dll.mui</TargetFilename>
        </Rule>

        <!-- (11) DISM 핵심 DLL -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\system32\wbem\wmiprvse.exe</Image>
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
        </Rule>
        
      </FileBlockExecutable>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
