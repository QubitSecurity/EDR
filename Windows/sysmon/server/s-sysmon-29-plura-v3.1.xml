<!-- NOTICE: PLURA Sysmon Configuration File Version 3.1 (Server - EventID 29 Only) -->
<!-- BASED ON: s-sysmon-27-plura.xml (Server-tailored Event ID 29(FileExecutableDetected) policy (converted from 27)) -->
<!-- DOWNLOAD: https://learn.microsoft.com/ko-kr/sysinternals/downloads/sysmon -->
<!-- INSTALL: Sysmon64.exe -accepteula -i "C:\Program Files (x86)\PLURA\s-sysmon-29-plura-v3.1.xml" -->
<!-- UPDATE:  Sysmon64.exe -c "C:\Program Files (x86)\PLURA\s-sysmon-29-plura-v3.1.xml" -->
<!-- DELETE:  Sysmon64.exe -u force -->

<!--
s-sysmon-29-plura-v3.1.xml (Server Event ID 29 전용)
- Server 환경에서 랜섬웨어 Drop/Run 경로, Office 체인 기반 EXE 생성 등을 "보수적으로" 탐지
- s-sysmon-plura-v3.1.xml(서버 기본 룰셋)과 분리 운영하거나, merge-29 구성과 함께 사용 가능
-->

<Sysmon schemaversion="4.90">
  <EventFiltering>

    <!-- SYSMON EVENT ID 29 : FILE EXECUTABLE DETECTED [FileExecutableDetected] - Server (보수적 적용) -->

    <!-- NOTE: Event ID 29는 차단(삭제)하지 않고, PE(실행파일) 생성 사실을 이벤트로 기록합니다. -->

    <!-- INCLUDE: 악성 Drop/Run 경로 (서버에 맞게 보수적으로) -->
    <RuleGroup name="Include_MalwareDrop_Server" groupRelation="or">
      <FileExecutableDetected onmatch="include">

        <!-- (A) 사용자 데이터 보호 (Honeypot) -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains any">
            \Documents\;
            \Pictures\;
            \Videos\;
            \Music\;
            \Favorites\;
            \Client_Contracts\
          </TargetFilename>
        </Rule>

        <!-- (B) 일반적 임시경로 (C:\Temp, C:\Windows\Temp) -->
        <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>

        <!-- (C) Office 체인 → Temp/Roaming EXE 생성 시 탐지 -->
        <Rule groupRelation="and">
          <Image condition="contains any">
            OUTLOOK.exe;
            WINWORD.exe;
            POWERPNT.exe;
            EXCEL.exe;
            VISIO.exe;
            MSACCESS.exe;
            MSPUB.exe;
            EQNEDT32.exe;
            TEAMS.exe;
            LYNC.exe
          </Image>
          <TargetFilename condition="contains any">
            \Temp\;
            \AppData\Local\Temp\;
            \AppData\Roaming\
          </TargetFilename>
        </Rule>

        <!-- (D) ZIP 기반 랜섬웨어 Drop (7z.exe 사용) -->
        <Rule groupRelation="and">
          <Image condition="end with">7z.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- 서버에서는 PowerShell/LOLBin의 Temp/ProgramData 전역 적용(확대)은 제외 -->

      </FileExecutableDetected>
    </RuleGroup>

    <!-- EXCLUDE: 정상 설치/업데이트/보안솔루션/개발 환경 예외 -->
    <RuleGroup name="Exclude_LegitActivity_Server" groupRelation="or">
      <FileExecutableDetected onmatch="exclude">

        <!-- (1) Outlook/Office 정상 임시 파일 -->
        <TargetFilename condition="contains">Content.Outlook\</TargetFilename>
        <TargetFilename condition="contains">Content.MSO\</TargetFilename>
        <TargetFilename condition="end with">MSForms.exd</TargetFilename>
        <TargetFilename condition="contains">~$</TargetFilename>

        <!-- (2) 정상 다운로드 폴더 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Downloads\</TargetFilename>
        </Rule>

        <!-- (3) PowerShell Profile 업데이트 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Documents\WindowsPowerShell\</TargetFilename>
        </Rule>

        <!-- (4) Windows Installer / Update -->
        <Image condition="is">C:\Windows\System32\msiexec.exe</Image>
        <Image condition="is">C:\Windows\servicing\TrustedInstaller.exe</Image>
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>
        <Image condition="is">C:\Windows\System32\dism.exe</Image>
        <Image condition="is">C:\Windows\System32\wusa.exe</Image>
        <Image condition="is">C:\Windows\System32\cleanmgr.exe</Image>
        <Image condition="is">C:\Windows\System32\wuauclt.exe</Image>

        <!-- (5) Windows 오류보고/진단 -->
        <Image condition="is">C:\Windows\System32\werfault.exe</Image>
        <Image condition="is">C:\Windows\System32\wermgr.exe</Image>

        <!-- (6) Windows CAB/압축 관련 -->
        <Image condition="is">C:\Windows\System32\makecab.exe</Image>
        <Image condition="is">C:\Windows\System32\iexpress.exe</Image>

        <!-- (7) 보안 솔루션 필수 예외 -->
        <Image condition="contains any">
          C:\ProgramData\Microsoft\Windows Defender\Platform\;
          MsMpEng.exe
        </Image>
        <Image condition="end with">MpSigStub.exe</Image>
        <Image condition="end with">NisSrv.exe</Image>
        <Image condition="end with">Sysmon.exe</Image>

        <!-- (8) Python 개발 환경 (필요 시 서버에 맞게 조정) -->
        <Image condition="contains">\venv\Scripts\python.exe</Image>
        <Image condition="contains">\python.exe</Image>
        <Image condition="contains">\pip.exe</Image>

        <!-- (9) 기타 자동 업데이트/에이전트 (환경에 맞게 추가/조정) -->
        <Image condition="contains any">
          msedge.exe;
          Squirrel.exe;
          Update.exe;
          Discord.exe;
          Teams.exe;
          Zoom.exe
        </Image>
        <Rule groupRelation="and">
          <Image condition="is">C:\Program Files\Google\Chrome\Application\chrome.exe</Image>
        </Rule>

        <Image condition="contains any">
          agent;
          updater;
          backup;
          monitor
        </Image>

        <Image condition="end with">OneDrive.exe</Image>

        <!-- (10) Windows Troubleshooter -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\System32\taskhostw.exe</Image>
          <TargetFilename condition="begin with">C:\Windows\Temp\SDIAG_</TargetFilename>
          <TargetFilename condition="contains any">.dll;.dll.mui</TargetFilename>
        </Rule>

        <!-- (11) DISM 핵심 DLL -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\system32\wbem\wmiprvse.exe</Image>
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
        </Rule>
        
      </FileExecutableDetected>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
