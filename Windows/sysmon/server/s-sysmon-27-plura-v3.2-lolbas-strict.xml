<!-- PLURA_CONFIG_VERSION: s-sysmon-27-plura-v3.2-lolbas-strict.xml --> 
<!-- PLURA_SCHEMA_TARGET: 4.90 -->

<Sysmon schemaversion="5.0">
  <HashAlgorithms>*</HashAlgorithms>
  <CheckRevocation>False</CheckRevocation>
  <DnsLookup>False</DnsLookup>
  <ArchiveDirectory>Sysmon</ArchiveDirectory>
  <EventFiltering>

    <!-- SYSMON EVENT ID 27 : FILE BLOCK EXECUTABLE [FileBlockExecutable] - Server (보수적 적용) -->

    <!-- INCLUDE: 악성 Drop/Run 경로 (서버에 맞게 보수적으로) -->
    <RuleGroup name="Include_MalwareDrop_Server" groupRelation="or">
      <FileBlockExecutable onmatch="include">

        <!-- (A) 사용자 데이터 보호 (Honeypot) -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains any">
            \Documents\;
            \Pictures\;
            \Videos\;
            \Music\;
            \Favorites\;
            \Client_Contracts\
          </TargetFilename>
        </Rule>

        <!-- (B) 일반적 임시경로 (C:\Temp, C:\Windows\Temp) -->
        <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>

        <!-- (C) Office 체인 → Temp/Roaming EXE 생성 시 차단 -->
        <Rule groupRelation="and">
          <Image condition="contains any">
            OUTLOOK.exe;
            WINWORD.exe;
            POWERPNT.exe;
            EXCEL.exe;
            VISIO.exe;
            MSACCESS.exe;
            MSPUB.exe;
            EQNEDT32.exe;
            TEAMS.exe;
            LYNC.exe
          </Image>
          <TargetFilename condition="contains any">
            \Temp\;
            \AppData\Local\Temp\;
            \AppData\Roaming\
          </TargetFilename>
        </Rule>

        <!-- (D) ZIP 기반 랜섬웨어 Drop (7z.exe 사용) -->
        <Rule groupRelation="and">
          <Image condition="end with">7z.exe</Image>
          <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        </Rule>

        <!-- 서버에서는 PowerShell/LOLBin의 Temp/ProgramData 전역 차단은 제외 -->

      </FileBlockExecutable>
    </RuleGroup>

    

    <!-- INCLUDE: LOLBAS Writer → PE drop in common staging paths (Server) -->
    <RuleGroup name="Include_LOLBAS_FileBlock_Server_Strict" groupRelation="or">
      <FileBlockExecutable onmatch="include">
        <Rule groupRelation="and">
          <Image condition="contains any">
            AddinUtil.exe;
            AppInstaller.exe;
            Aspnet_Compiler.exe;
            At.exe;
            Atbroker.exe;
            Bash.exe;
            Bitsadmin.exe;
            CertOC.exe;
            CertReq.exe;
            Certutil.exe;
            Change.exe;
            Cipher.exe;
            Cmd.exe;
            Cmdkey.exe;
            Cmstp.exe;
            Colorcpl.exe;
            ComputerDefaults.exe;
            ConfigSecurityPolicy.exe;
            Conhost.exe;
            Control.exe;
            Csc.exe;
            Cscript.exe;
            CustomShellHost.exe;
            DataSvcUtil.exe;
            Desktopimgdownldr.exe;
            DeviceCredentialDeployment.exe;
            Dfsvc.exe;
            Diantz.exe;
            Diskshadow.exe;
            Dnscmd.exe;
            Esentutl.exe;
            Eudcedit.exe;
            Eventvwr.exe;
            Expand.exe;
            Explorer.exe;
            Extexport.exe;
            Extrac32.exe;
            Findstr.exe;
            Finger.exe;
            Forfiles.exe;
            Fsutil.exe;
            Ftp.exe;
            Gpscript.exe;
            Hh.exe;
            IMEWDBLD.exe;
            Ie4uinit.exe;
            Ieexec.exe;
            Ilasm.exe;
            Infdefaultinstall.exe;
            Installutil.exe;
            Jsc.exe;
            Ldifde.exe;
            Makecab.exe;
            Mavinject.exe;
            Microsoft.Workflow.Compiler.exe;
            Mmc.exe;
            MpCmdRun.exe;
            Msbuild.exe;
            Msconfig.exe;
            Msdt.exe;
            Msedge.exe;
            Mshta.exe;
            Msiexec.exe;
            Netsh.exe;
            Ngen.exe;
            Odbcconf.exe;
            OfflineScannerShell.exe;
            OneDriveStandaloneUpdater.exe;
            Pcalua.exe;
            Pcwrun.exe;
            Pktmon.exe;
            Pnputil.exe;
            Presentationhost.exe;
            Print.exe;
            PrintBrm.exe;
            Provlaunch.exe;
            Psr.exe;
            Query.exe;
            Rasautou.exe;
            Reg.exe;
            Regasm.exe;
            Regedit.exe;
            Regini.exe;
            Register-cimprovider.exe;
            Regsvcs.exe;
            Regsvr32.exe;
            Replace.exe;
            Reset.exe;
            Rpcping.exe;
            Rundll32.exe;
            Runexehelper.exe;
            Runonce.exe;
            Runscripthelper.exe;
            Sc.exe;
            Schtasks.exe;
            Scriptrunner.exe;
            Setres.exe;
            SettingSyncHost.exe;
            Sftp.exe;
            Stordiag.exe;
            SyncAppvPublishingServer.exe;
            Tar.exe;
            Ttdinject.exe;
            Tttracer.exe;
            Unregmp2.exe;
            Verclsid.exe;
            Wab.exe;
            Wlrmdr.exe;
            Wmic.exe;
            WorkFolders.exe;
            Wscript.exe;
            Wsreset.exe;
            Xwizard.exe;
            cmdl32.exe;
            fltMC.exe;
            iediagcmd.exe;
            iscsicpl.exe;
            msedge_proxy.exe;
            msedgewebview2.exe;
            rdrleakdiag.exe;
            ssh.exe;
            vbc.exe;
            wbadmin.exe;
            wbemtest.exe;
            winget.exe;
            wt.exe;
            wuauclt.exe;
          </Image>
          <TargetFilename condition="contains any">
            C:\Users\;
            C:\Users\Public\;
            C:\ProgramData\;
            C:\Windows\Temp\;
            C:\Temp\;
          </TargetFilename>
        </Rule>
      </FileBlockExecutable>
    </RuleGroup>
<!-- EXCLUDE: 정상 설치/업데이트/보안솔루션/개발 환경 예외 -->
    <RuleGroup name="Exclude_LegitActivity_Server" groupRelation="or">
      <FileBlockExecutable onmatch="exclude">

        <!-- (1) Outlook/Office 정상 임시 파일 -->
        <TargetFilename condition="contains">Content.Outlook\</TargetFilename>
        <TargetFilename condition="contains">Content.MSO\</TargetFilename>
        <TargetFilename condition="end with">MSForms.exd</TargetFilename>
        <TargetFilename condition="contains">~$</TargetFilename>

        <!-- (2) 정상 다운로드 폴더 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Downloads\</TargetFilename>
        </Rule>

        <!-- (3) PowerShell Profile 업데이트 -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="contains">\Documents\WindowsPowerShell\</TargetFilename>
        </Rule>

        <!-- (4) Windows Installer / Update -->
        <Image condition="is">C:\Windows\System32\msiexec.exe</Image>
        <Image condition="is">C:\Windows\servicing\TrustedInstaller.exe</Image>
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>
        <Image condition="is">C:\Windows\System32\dism.exe</Image>
        <Image condition="is">C:\Windows\System32\wusa.exe</Image>
        <Image condition="is">C:\Windows\System32\cleanmgr.exe</Image>
        <Image condition="is">C:\Windows\System32\wuauclt.exe</Image>

        <!-- (5) Windows 오류보고/진단 -->
        <Image condition="is">C:\Windows\System32\werfault.exe</Image>
        <Image condition="is">C:\Windows\System32\wermgr.exe</Image>

        <!-- (6) Windows CAB/압축 관련 -->
        <Image condition="is">C:\Windows\System32\makecab.exe</Image>
        <Image condition="is">C:\Windows\System32\iexpress.exe</Image>

        <!-- (7) 보안 솔루션 필수 예외 -->
        <Image condition="contains any">
          C:\ProgramData\Microsoft\Windows Defender\Platform\;
          MsMpEng.exe
        </Image>
        <Image condition="end with">MpSigStub.exe</Image>
        <Image condition="end with">NisSrv.exe</Image>
        <Image condition="end with">Sysmon.exe</Image>

        <!-- (8) Python 개발 환경 (필요 시 서버에 맞게 조정) -->
        <Image condition="contains">\venv\Scripts\python.exe</Image>
        <Image condition="contains">\python.exe</Image>
        <Image condition="contains">\pip.exe</Image>

        <!-- (9) 기타 자동 업데이트/에이전트 (환경에 맞게 추가/조정) -->
        <Image condition="contains any">
          msedge.exe;
          Squirrel.exe;
          Update.exe;
          Discord.exe;
          Teams.exe;
          Zoom.exe
        </Image>
        <Rule groupRelation="and">
          <Image condition="is">C:\Program Files\Google\Chrome\Application\chrome.exe</Image>
        </Rule>

        <Image condition="contains any">
          agent;
          updater;
          backup;
          monitor
        </Image>

        <Image condition="end with">OneDrive.exe</Image>

        <!-- (10) Windows Troubleshooter -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\System32\taskhostw.exe</Image>
          <TargetFilename condition="begin with">C:\Windows\Temp\SDIAG_</TargetFilename>
          <TargetFilename condition="contains any">.dll;.dll.mui</TargetFilename>
        </Rule>

        <!-- (11) DISM 핵심 DLL -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\system32\wbem\wmiprvse.exe</Image>
          <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
        </Rule>
        
      </FileBlockExecutable>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
